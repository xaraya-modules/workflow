<?xml version="1.0" encoding="utf-8"?>
<xar:template xmlns:xar="http://xaraya.com/2004/blocklayout">
  <!-- this relies on $config and $item from trackerlist or test_run, or on $workflow, $subjectId, $place and $trackerId if available -->
  <xar:if condition="empty($config)">
    <xar:set name="config">$xar->mod()->apiFunc('workflow', 'user', 'getconfig')</xar:set>
  </xar:if>
  <xar:if condition="empty($tracker)">
    <xar:set name="tracker">$xar->mod()->apiFunc('workflow', 'user', 'tracker')</xar:set>
  </xar:if>
  <xar:if condition="!empty($trackerId) and empty($workflow) and empty($item)">
    <xar:set name="item">$tracker->getTrackerItem($trackerId)</xar:set>
  </xar:if>
  <xar:set name="displaylink">$xar->ctl()->getObjectURL($item['object'], 'display', ['itemid' => $item['item']])</xar:set>
  <xar:set name="infolink">$xar->ctl()->getObjectURL('workflow_tracker', 'display', ['itemid' => $item['tracker_id']])</xar:set>
  <xar:set name="params">['workflow' => $item['workflow']]</xar:set>
  <xar:set name="workflowlink">$xar->ctl()->getModuleURL('workflow', 'user', 'test', $params)</xar:set>
  <xar:set name="currentId">$tracker->toSubjectId($item['object'], $item['item'])</xar:set>
  <xar:set name="params">$params + ['subjectId' => $currentId]</xar:set>
  <xar:set name="subjectlink">$xar->ctl()->getModuleURL('workflow', 'user', 'test', $params)</xar:set>
  <xar:set name="params">$params + ['trackerId' => $item['tracker_id']]</xar:set>
  <xar:set name="trackerlink">$xar->ctl()->getModuleURL('workflow', 'user', 'test', $params)</xar:set>
  <fieldset>
    <legend><a href="#$workflowlink#">#$config[$item['workflow']]['label']#</a></legend>
    <div class="xar-row">
      <div class="xar-col">
        <label>History Id</label>
      </div>
      <div class="xar-col">
        #$item['id']#
      </div>
    </div>
    <div class="xar-row">
      <div class="xar-col">
        <label>Tracker Id</label>
      </div>
      <div class="xar-col">
        <a href="#$infolink#" title="Info Tracker (#$item['tracker_id']#) #$currentId#">
          <xar:img scope="theme" file="icons/info.png" class="xar-icon" alt="info"/>
        </a>&#160;
        <a href="#$trackerlink#" title="Filter Tracker (#$item['tracker_id']#) #$currentId#">#$item['tracker_id']#</a>
      </div>
    </div>
    <div class="xar-row">
      <div class="xar-col">
        <label>Subject Id</label>
      </div>
      <div class="xar-col">
        <a href="#$displaylink#" title="Display Subject #$currentId#">
          <xar:img scope="theme" file="icons/display.png" class="xar-icon" alt="display"/>
        </a>&#160;
        <a href="#$subjectlink#" title="Filter Subject #$currentId#">#$currentId#</a>
      </div>
    </div>
    <div class="xar-row">
      <div class="xar-col">
        <label>Transition</label>
      </div>
      <div class="xar-col">
        #ucwords(str_replace('_', ' ', $item['transition']))#
      </div>
    </div>
    <div class="xar-row">
      <div class="xar-col">
        <label>To Place</label>
      </div>
      <div class="xar-col">
        <!-- @checkme use wildcard prefix for multiState workflow places -->
        <xar:if condition="$config[$item['workflow']]['type'] eq 'workflow'">
          <xar:set name="prefix">'%'</xar:set>
        <xar:else/>
          <xar:set name="prefix">''</xar:set>
        </xar:if>
        <xar:set name="places">explode($tracker::AND_OPERATOR, $item['marking'])</xar:set>
        <xar:foreach in="$places" value="$here">
          <xar:set name="placelink">$xar->ctl()->getModuleURL('workflow', 'user', 'test', ['workflow' => $item['workflow'], 'place' => $prefix . $here])</xar:set>
          <xar:set name="where">ucwords(str_replace('_', ' ', $here))</xar:set>
          <a href="#$placelink#" title="Filter Place #$where#">#$where#</a>&#160;
        </xar:foreach>
      </div>
    </div>
    <div class="xar-row">
      <div class="xar-col">
        <label>User Name</label>
      </div>
      <div class="xar-col">
        #$xar->user($item['user'])->getVar('name')#
      </div>
    </div>
    <div class="xar-row">
      <div class="xar-col">
        <label>Updated</label>
      </div>
      <div class="xar-col">
        #$xar->mls()->getFormattedDate('medium',$item['updated'])#
        #$xar->mls()->getFormattedTime('short',$item['updated'])#
      </div>
    </div>
    <div class="xar-row">
      <div class="xar-col">
        <label>Context</label>
      </div>
      <div class="xar-col">
        <xar:set name="decoded">json_decode($item['context'])</xar:set>
        <xar:set name="encoded">json_encode($decoded, JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE | JSON_UNESCAPED_SLASHES | JSON_PARTIAL_OUTPUT_ON_ERROR)</xar:set>
        <pre>#$encoded#</pre>
      </div>
    </div>
  </fieldset>
</xar:template>
